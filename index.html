<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Assessment</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
    .hidden { display: none !important; }
    .btn-toggle { transition: all 0.2s; border: 2px solid #e2e8f0; opacity: 0.7; }
    .btn-toggle:hover { opacity: 1; transform: translateY(-1px); }
    .btn-pass.active { background-color: #22c55e; border-color: #22c55e; color: white; opacity: 1; }
    .btn-fail.active { background-color: #ef4444; border-color: #ef4444; color: white; opacity: 1; }
    .a4-container { width: 210mm; min-height: 297mm; background: white; padding: 15mm; margin: 0 auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .avoid-break { page-break-inside: avoid; }
    .badge-pass { color: #166534; background-color: #dcfce7; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; border: 1px solid #166534; display: inline-block; min-width: 80px; text-align: center; }
    .badge-fail { color: #991b1b; background-color: #fee2e2; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; border: 1px solid #991b1b; display: inline-block; min-width: 80px; text-align: center; }
    .badge-wait { color: #64748b; background-color: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 11px; border: 1px dashed #94a3b8; display: inline-block; min-width: 80px; text-align: center; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">

  <!-- AUTH PAGE (Google only) -->
  <div id="authPage" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-slate-100">
      <div class="mb-6"><span class="bg-indigo-100 text-indigo-600 p-3 rounded-xl text-3xl">‚öì</span></div>
      <h1 class="text-2xl font-bold text-slate-800 mb-2">Teacher Assessment</h1>
      <p class="text-slate-500 mb-8 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞ (Maritime & Navigation)</p>

      <button id="googleLoginBtn"
        class="w-full flex items-center justify-center bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl shadow-sm transition">
        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Google
      </button>
<button id="demoBtn"
  class="w-full mt-3 flex items-center justify-center bg-slate-800 hover:bg-black text-white font-bold py-3 px-4 rounded-xl shadow-sm transition">
  ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î Demo (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Login)
</button>


      <div id="authMessage" class="mt-4 text-red-500 text-sm font-bold"></div>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profilePage" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100">
      <div class="mb-6 text-center">
        <div class="text-4xl mb-2">üßæ</div>
        <h2 class="text-2xl font-bold text-slate-800">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
        <p class="text-slate-500 text-sm mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>

      <label class="block text-sm font-bold text-slate-600 mb-2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
      <input id="profileFullName" type="text"
        class="w-full border rounded-lg px-4 py-3 mb-5 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-300"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" />

      <label class="block text-sm font-bold text-slate-600 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
      <div class="grid grid-cols-2 gap-3 mb-6">
        <label class="border rounded-xl p-4 cursor-pointer hover:border-indigo-400 bg-white">
          <div class="flex items-center gap-3">
            <input type="radio" name="userRole" value="teacher" class="w-4 h-4" checked>
            <div>
              <div class="font-bold text-slate-800">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</div>
              <div class="text-xs text-slate-500">Teacher</div>
            </div>
          </div>
        </label>

        <label class="border rounded-xl p-4 cursor-pointer hover:border-teal-400 bg-white">
          <div class="flex items-center gap-3">
            <input type="radio" name="userRole" value="head" class="w-4 h-4">
            <div>
              <div class="font-bold text-slate-800">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤)</div>
              <div class="text-xs text-slate-500">Evaluator / Head</div>
            </div>
          </div>
        </label>
      </div>

      <button onclick="saveProfileAndContinue()"
        class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 shadow-md">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏ï‡πà‡∏≠
      </button>

      <p id="profileMsg" class="text-center text-sm text-red-500 font-bold mt-4"></p>
    </div>
  </div>

  <!-- SELECTION PAGE -->
  <div id="selectionPage" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
    <h2 class="text-2xl font-bold text-slate-700 mb-2">
      ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö <span id="userDisplay" class="text-indigo-600">User</span>
    </h2>
    <p class="text-slate-500 mb-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl mb-6">
      <button id="btnSelf" onclick="startSelfAssessment()"
        class="bg-white hover:bg-indigo-50 border-2 border-slate-100 hover:border-indigo-500 p-8 rounded-2xl shadow-sm transition text-center group">
        <div class="text-5xl mb-4 group-hover:scale-110 transition">üìù</div>
        <h3 class="text-xl font-bold text-slate-800 group-hover:text-indigo-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
        <p class="text-slate-400 text-sm mt-2">Self-Assessment</p>
      </button>

      <button id="btnTeam" onclick="startTeamAssessment()"
        class="bg-white hover:bg-teal-50 border-2 border-slate-100 hover:border-teal-500 p-8 rounded-2xl shadow-sm transition text-center group">
        <div class="text-5xl mb-4 group-hover:scale-110 transition">üë•</div>
        <h3 class="text-xl font-bold text-slate-800 group-hover:text-teal-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°</h3>
        <p class="text-slate-400 text-sm mt-2">Team Evaluation</p>
      </button>
    </div>

    <button onclick="openExportModal()"
      class="w-full max-w-2xl bg-white border-2 border-slate-200 hover:border-orange-400 hover:bg-orange-50 text-slate-600 hover:text-orange-600 font-bold py-4 rounded-xl shadow-sm flex items-center justify-center gap-3 transition group">
      <span class="text-2xl group-hover:scale-110 transition">üñ®Ô∏è</span>
      <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Portfolio PDF)</span>
    </button>

    <button onclick="logout()" class="mt-12 text-slate-400 hover:text-red-500 text-sm underline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <!-- SELF SELECT PAGE -->
  <div id="selfSelectPage" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
      <button onclick="goBack('selectionPage')" class="text-sm text-slate-400 mb-4">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <h2 class="text-2xl font-bold text-indigo-600 mb-6">üìù ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h2>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
          <select id="selfYearSelect" onchange="updateSelfSubjects()" class="w-full border p-2 rounded-lg bg-slate-50">
            <option value="2567">2567</option>
            <option value="2568" selected>2568</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">‡πÄ‡∏ó‡∏≠‡∏°</label>
          <select id="selfTermSelect" onchange="updateSelfSubjects()" class="w-full border p-2 rounded-lg bg-slate-50">
            <option value="1">‡πÄ‡∏ó‡∏≠‡∏° 1</option>
            <option value="2" selected>‡πÄ‡∏ó‡∏≠‡∏° 2</option>
          </select>
        </div>
      </div>

      <label class="block text-sm font-bold text-slate-600 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô (Deck/PCP)</label>
      <select id="selfClassSelect" class="w-full border p-3 rounded-lg mb-4 bg-slate-50 text-slate-700">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
        <option value="DECK 1 & PCP 4D">DECK 1 & PCP 4D</option>
        <option value="DECK 2 & PCP 5D">DECK 2 & PCP 5D</option>
        <option value="DECK 3">DECK 3</option>
        <option value="DECK 4">DECK 4</option>
      </select>

      <label class="block text-sm font-bold text-slate-600 mb-2">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</label>
      <select id="selfSubjectSelect" class="w-full border p-3 rounded-lg mb-6 bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400">
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ/‡πÄ‡∏ó‡∏≠‡∏°/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
      </select>

      <button onclick="confirmSelfSelection()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 shadow-md">
        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      </button>
    </div>
  </div>

  <!-- TEAM TEACHER PAGE -->
  <div id="teamTeacherPage" class="hidden min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <button onclick="goBack('selectionPage')" class="text-sm text-slate-500 mb-6">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <h2 class="text-2xl font-bold text-teal-700 mb-6">üë• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
      <div id="teacherListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- TEAM SUBJECT PAGE -->
  <div id="teamSubjectPage" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
      <button onclick="goBack('teamTeacherPage')" class="text-sm text-slate-400 mb-4">‚Üê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</button>
      <h2 class="text-xl font-bold text-slate-800 text-center mb-6" id="selectedTeacherName">...</h2>
      <div class="bg-teal-50 p-4 rounded-lg mb-4 text-sm text-teal-800 border border-teal-200">
        <p><strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2567 / ‡πÄ‡∏ó‡∏≠‡∏° 1</p>
      </div>
      <div id="teacherSubjectList" class="space-y-3"></div>
    </div>
  </div>

  <!-- ASSESSMENT PAGE -->
  <div id="assessmentPage" class="hidden min-h-screen p-4 md:p-8 bg-white">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center border-b pb-4 mb-6 sticky top-0 bg-white z-10 pt-2">
        <div>
          <button onclick="exitAssessment()" class="text-xs text-slate-400 hover:text-red-500 mb-1">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <h1 class="text-2xl font-bold text-slate-800">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</h1>
          <p class="text-indigo-600 text-sm font-bold" id="formSubtitle">...</p>
        </div>
        <div class="text-right">
          <span id="modeBadge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200">Mode</span>
          <p id="termDisplay" class="text-xs text-slate-500 mt-1">...</p>
        </div>
      </div>

      <div id="competencyListContainer" class="space-y-6 mb-12"></div>

      <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 sticky bottom-4 shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-slate-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏∏‡∏ì):</h3>
          <span class="text-2xl font-bold text-indigo-600" id="scoreSummary">0/0</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <button onclick="saveData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg">
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
          </button>
          <button onclick="openPreview()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2">
            <span>üñ®Ô∏è</span> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á PDF
          </button>
          <button onclick="clearAssessmentData()" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 rounded-lg shadow-lg">
            üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- EXPORT SELECT MODAL -->
  <div id="exportSelectModal" class="hidden fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
      <h3 class="text-lg font-bold text-slate-700 mb-2">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
      <p class="text-xs text-slate-500 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</p>
      <label class="block text-xs font-bold text-slate-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π (Select Teacher)</label>
      <select id="exportTeacherSelect" class="w-full border p-2 rounded-lg mb-6 bg-slate-50"></select>
      <div class="flex gap-2">
        <button onclick="closeExportModal()" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button onclick="confirmExportTeacher()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded-lg shadow-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="previewModal" class="hidden fixed inset-0 bg-slate-900/90 z-50 overflow-y-auto backdrop-blur-sm">
    <div class="min-h-screen py-8 px-4 flex justify-center">
      <div class="w-full max-w-[220mm]">
        <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-lg sticky top-4 z-50">
          <div>
            <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
            <p class="text-xs text-slate-500">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô (‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</p>
          </div>
          <div class="flex gap-2">
            <button onclick="closePreview()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">‡∏õ‡∏¥‡∏î</button>
            <button onclick="downloadPDF()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 flex items-center gap-2 shadow-md">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
          </div>
        </div>

        <div id="pdfContent" class="a4-container relative">
          <div class="flex justify-between items-start border-b-2 border-slate-800 pb-6 mb-8">
            <div>
              <h1 class="text-2xl font-bold text-slate-900">‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</h1>
              <p class="text-sm text-slate-600">Teacher Competency Assessment Report</p>
            </div>
            <div class="text-right"><div class="text-4xl">‚öì</div></div>
          </div>

          <div class="bg-slate-50 border rounded-lg p-4 mb-6 grid grid-cols-2 gap-4 text-sm">
            <div><span class="font-bold text-slate-500 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</span> <span id="prevEvaluatee" class="text-lg font-bold">...</span></div>
            <div><span class="font-bold text-slate-500 block">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span> <span id="prevPosition" class="text-lg">...</span></div>
            <div><span class="font-bold text-slate-500 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span> <span id="printDate">...</span></div>
            <div><span class="font-bold text-slate-500 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> <span>‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span></div>
          </div>

          <div id="previewBody"></div>

          <div class="mt-12 grid grid-cols-2 gap-10 pt-8 border-t break-inside-avoid">
            <div class="text-center">
              <div class="border-b border-dotted border-slate-400 mb-2 h-8"></div>
              <p class="text-xs font-bold">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>
            </div>
            <div class="text-center">
              <div class="border-b border-dotted border-slate-400 mb-2 h-8"></div>
              <p class="text-xs font-bold">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- COMMON HELPERS -->
  <script>
    window.currentUser = null;
    window.currentUserProfile = null;

    function showPage(pageId) {
      document.querySelectorAll('div[id$="Page"], div[id$="Modal"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(pageId).classList.remove('hidden');
    }

    function getProfileKey(uid) { return `TA_PROFILE_${uid}`; }

    function loadProfile(uid) {
      try {
        const raw = localStorage.getItem(getProfileKey(uid));
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function saveProfile(uid, profile) {
      localStorage.setItem(getProfileKey(uid), JSON.stringify(profile));
    }

    function applyProfileToUI() {
      const profile = window.currentUserProfile;
      const nameToShow = profile?.fullName || window.currentUser?.displayName || 'User';
      document.getElementById('userDisplay').innerText = nameToShow;

      const isTeacher = profile?.role === 'teacher';
      const isHead = profile?.role === 'head';

      const btnSelf = document.getElementById('btnSelf');
      const btnTeam = document.getElementById('btnTeam');

      if (btnSelf && btnTeam) {
        btnSelf.classList.toggle('hidden', isHead);
        btnTeam.classList.toggle('hidden', isTeacher);
      }
    }
  </script>

  <!-- FIREBASE AUTH (Google only) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCxjZ7PcKiVZO4XwTOyE6qy3W1veK0no0E",
      authDomain: "teacher-assessment-a2b95.firebaseapp.com",
      projectId: "teacher-assessment-a2b95",
      storageBucket: "teacher-assessment-a2b95.firebasestorage.app",
      messagingSenderId: "570896748488",
      appId: "1:570896748488:web:0aba8e75b7ca8fb7737afd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    window.context = {};
    window.currentMode = '';
    window.mockDB = {}; // Mock DB for demo purpose

    onAuthStateChanged(auth, (user) => {
      if (user) {
        window.currentUser = user;

        // ‡πÉ‡∏ä‡πâ uid ‡πÄ‡∏õ‡πá‡∏ô teacherId (‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)
        window.currentUser.teacherId = user.uid;

        const prof = loadProfile(user.uid);
        window.currentUserProfile = prof;

        if (!prof) {
          document.getElementById('profileFullName').value = user.displayName || '';
          showPage('profilePage');
        } else {
          applyProfileToUI();
          showPage('selectionPage');
        }
      } else {
        showPage('authPage');
      }
    });

    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      try { await signInWithPopup(auth, provider); }
      catch (e) { document.getElementById('authMessage').innerText = e.message; }
    });

    window.logout = () => signOut(auth).then(() => location.reload());
  </script>

  <!-- APP LOGIC -->
  <script>
    // --- SUBJECT DB ---
    const subjectsDB = {
      '30000-1410': { name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠ 1 (30000-1410)', assignedDeck: 'DECK 1 & PCP 4D', competencies: ['‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠', '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•', '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠'] },
      '30000-1305': { name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏Ø (30000-1305)', assignedDeck: 'DECK 1 & PCP 4D', competencies: ['‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏≠‡∏∏‡∏ì‡∏´‡∏û‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏Å‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á'] },
      'AM-03-MATH': { name: 'AMCOL WAY 03 MATH', assignedDeck: 'DECK 2 & PCP 5D', competencies: ['Calculus Foundation', 'Vector Analysis', 'Matrix & Determinant'] },
      'AM-03-SCI': { name: 'AMCOL WAY 03 SCI', assignedDeck: 'DECK 2 & PCP 5D', competencies: ['Physics for Navigation', 'Wave & Optics', 'Energy Conservation'] },
      'AM-05-MATH': { name: 'AMCOL WAY 05 MATH', assignedDeck: 'DECK 3', competencies: ['Advanced Algebra', 'Statistics Probability', 'Complex Numbers'] },
      'AM-05-SCI': { name: 'AMCOL WAY 05 SCI', assignedDeck: 'DECK 3', competencies: ['Chemistry Basic', 'Material Properties', 'Environmental Science'] },
      'AM-07-MATH': { name: 'AMCOL WAY 07 MATH', assignedDeck: 'DECK 4', competencies: ['Numerical Method', 'Optimization', 'Spherical Trigonometry'] },
      'AM-07-SCI': { name: 'AMCOL WAY 07 SCI', assignedDeck: 'DECK 4', competencies: ['Modern Physics', 'Astronomy Basic', 'Geology for Sea'] },
      '30000-1411': { name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠ 2 (30000-1411)', assignedDeck: 'DECK 1 & PCP 4D', competencies: ['‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠', '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î', 'Celestial Navigation'] },
      '30000-1312': { name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠ (30000-1312)', assignedDeck: 'DECK 1 & PCP 4D', competencies: ['‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û', '‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•', '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥'] },
      'AM-04-MATH': { name: 'AMCOL WAY 04 MATH', assignedDeck: 'DECK 2 & PCP 5D', competencies: ['Math Logic', 'Set Theory', 'Functions & Graphs'] },
      'AM-04-SCI': { name: 'AMCOL WAY 04 SCI', assignedDeck: 'DECK 2 & PCP 5D', competencies: ['Electricity & Magnetism', 'Circuit Basic', 'Electromagnetic Waves'] },
      'AM-06-MATH': { name: 'AMCOL WAY 06 MATH', assignedDeck: 'DECK 3', competencies: ['Calculus II', 'Integration Tech', 'Polar Coordinates'] },
      'AM-06-SCI': { name: 'AMCOL WAY 06 SCI', assignedDeck: 'DECK 3', competencies: ['Fluid Dynamics', 'Thermodynamics II', 'Heat Transfer'] },
      'AM-08-MATH': { name: 'AMCOL WAY 08 MATH', assignedDeck: 'DECK 4', competencies: ['Applied Statistics', 'Data Analysis', 'Navigation Math Advanced'] },
      'AM-08-SCI': { name: 'AMCOL WAY 08 SCI', assignedDeck: 'DECK 4', competencies: ['Marine Technology', 'Signal Processing', 'Radio Communication Sci'] }
    };

    // --- TEACHERS DB (demo only) ---
    const teachersDB = [
      { id: 't2', name: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏°‡∏ß‡∏î (Demo)', schedule: { '2567': { '1': ['30000-1410', '30000-1411'] } } }
    ];

    // demo schedule for logged-in users (replace with real DB later)
    const demoScheduleForLoggedInUser = {
      '2567': {
        '1': ['30000-1410', '30000-1305', 'AM-03-MATH', 'AM-03-SCI', 'AM-05-MATH', 'AM-05-SCI', 'AM-07-MATH', 'AM-07-SCI'],
        '2': ['30000-1411', '30000-1312', 'AM-04-MATH', 'AM-04-SCI', 'AM-06-MATH', 'AM-06-SCI', 'AM-08-MATH', 'AM-08-SCI']
      },
      '2568': {
        '1': ['30000-1410', '30000-1305', 'AM-03-MATH', 'AM-03-SCI', 'AM-05-MATH', 'AM-05-SCI', 'AM-07-MATH', 'AM-07-SCI'],
        '2': ['30000-1411', '30000-1312', 'AM-04-MATH', 'AM-04-SCI', 'AM-06-MATH', 'AM-06-SCI', 'AM-08-MATH', 'AM-08-SCI']
      }
    };

    function upsertLoggedInUserToTeachersDB() {
      if (!window.currentUser) return;
      const tid = window.currentUser.teacherId || window.currentUser.uid;
      const name = window.currentUserProfile?.fullName || window.currentUser.displayName || 'User';

      let t = teachersDB.find(x => x.id === tid);
      if (!t) {
        teachersDB.push({ id: tid, name, schedule: demoScheduleForLoggedInUser });
      } else {
        t.name = name;
        if (!t.schedule || Object.keys(t.schedule).length === 0) t.schedule = demoScheduleForLoggedInUser;
      }
    }

    // save profile (no admin)
    window.saveProfileAndContinue = () => {
      const fullName = document.getElementById('profileFullName').value.trim();
      const role = document.querySelector('input[name="userRole"]:checked')?.value;

      if (!fullName) { document.getElementById('profileMsg').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'; return; }
      if (!role) { document.getElementById('profileMsg').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; return; }

      const uid = window.currentUser?.uid;
      const profile = { fullName, role };

      saveProfile(uid, profile);
      window.currentUserProfile = profile;

      upsertLoggedInUserToTeachersDB();
      applyProfileToUI();
      showPage('selectionPage');
    };

    function goBack(target) { showPage(target); }

    function updateSelfSubjects() {
      const year = document.getElementById('selfYearSelect').value;
      const term = document.getElementById('selfTermSelect').value;
      const deck = document.getElementById('selfClassSelect').value;
      const select = document.getElementById('selfSubjectSelect');

      select.innerHTML = '';
      select.disabled = true;

      if (!deck) {
        select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>';
        return;
      }

      upsertLoggedInUserToTeachersDB();
      const myId = window.currentUser?.teacherId;
      const teacherData = teachersDB.find(t => t.id === myId);

      if (!teacherData || !teacherData.schedule?.[year]?.[term]) {
        select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ/‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</option>';
        return;
      }

      const allSubjectsInTerm = teacherData.schedule[year][term];
      const filteredSubjects = allSubjectsInTerm.filter(subID => subjectsDB[subID]?.assignedDeck === deck);

      if (filteredSubjects.length === 0) {
        select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ</option>';
        return;
      }

      select.disabled = false;
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';
      filteredSubjects.forEach(subKey => {
        select.innerHTML += `<option value="${subKey}">${subjectsDB[subKey].name}</option>`;
      });
    }

    document.getElementById('selfClassSelect').addEventListener('change', updateSelfSubjects);

    function startSelfAssessment() {
      window.currentMode = 'self';
      document.getElementById('selfYearSelect').value = '2568';
      document.getElementById('selfTermSelect').value = '2';
      document.getElementById('selfClassSelect').value = '';
      updateSelfSubjects();
      showPage('selfSelectPage');
    }

    function confirmSelfSelection() {
      const cls = document.getElementById('selfClassSelect').value;
      const subj = document.getElementById('selfSubjectSelect').value;
      const year = document.getElementById('selfYearSelect').value;
      const term = document.getElementById('selfTermSelect').value;
      if (!cls || !subj) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

      const myId = window.currentUser?.teacherId;
      setupContext(
        myId,
        window.currentUserProfile?.fullName || window.currentUser?.displayName,
        window.currentUserProfile?.fullName || window.currentUser?.displayName,
        subj,
        cls,
        [subj],
        year,
        term
      );
      renderForm();
    }

    function startTeamAssessment() {
      window.currentMode = 'team';
      const container = document.getElementById('teacherListContainer');
      container.innerHTML = '';

      upsertLoggedInUserToTeachersDB();

      teachersDB.forEach(t => {
        const currentSubjects = (t.schedule?.['2567'] && t.schedule?.['2567']?.['1']) ? t.schedule['2567']['1'] : [];
        container.innerHTML += `
          <div onclick="selectTeacher('${t.id}')" class="bg-white p-6 rounded-xl border hover:border-teal-500 cursor-pointer shadow-sm flex items-center gap-4">
            <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center">üë§</div>
            <div>
              <h3 class="font-bold">${t.name}</h3>
              <p class="text-xs text-slate-400">‡∏™‡∏≠‡∏ô ${currentSubjects.length} ‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ó‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</p>
            </div>
          </div>`;
      });

      showPage('teamTeacherPage');
    }

    function selectTeacher(tid) {
      window.tempTeacher = teachersDB.find(x => x.id === tid);
      document.getElementById('selectedTeacherName').innerText = window.tempTeacher.name;

      const list = document.getElementById('teacherSubjectList');
      list.innerHTML = '';

      const subs = (window.tempTeacher.schedule?.['2567'] && window.tempTeacher.schedule?.['2567']?.['1']) ? window.tempTeacher.schedule['2567']['1'] : [];
      if (subs.length === 0) {
        list.innerHTML = '<p class="text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</p>';
      } else {
        subs.forEach(k => {
          if (subjectsDB[k]) {
            list.innerHTML += `
              <button onclick="confirmTeamSubject('${k}')" class="w-full text-left bg-slate-50 p-4 rounded hover:bg-teal-50 border flex justify-between">
                ${subjectsDB[k].name} <span>‚Üí</span>
              </button>`;
          }
        });
      }
      showPage('teamSubjectPage');
    }

    function confirmTeamSubject(sk) {
      const allSubs = window.tempTeacher.schedule?.['2567']?.['1'] || [];
      setupContext(
        window.tempTeacher.id,
        window.tempTeacher.name,
        window.currentUserProfile?.fullName || window.currentUser?.displayName,
        sk,
        '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        allSubs,
        '2567',
        '1'
      );
      renderForm();
    }

    function setupContext(tid, tName, evName, subId, cls, allSubs, year, term) {
      window.context = { targetTeacherId: tid, evaluateeName: tName, evaluatorName: evName, subjectId: subId, classLevel: cls, allSubjects: allSubs, year, term };
      const dbKey = `${tid}_${subId}`;
      if (!window.mockDB[dbKey]) window.mockDB[dbKey] = {};
    }

    function renderForm() {
      const sub = subjectsDB[window.context.subjectId];
      if (!sub) return alert("Error: Subject data not found");

      document.getElementById('formSubtitle').innerText = sub.name;
      document.getElementById('termDisplay').innerText = `‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${window.context.year} / ‡πÄ‡∏ó‡∏≠‡∏° ${window.context.term}`;

      const badge = document.getElementById('modeBadge');
      if (window.currentMode === 'self') {
        badge.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á";
        badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700";
      } else {
        badge.innerText = "‡πÇ‡∏´‡∏°‡∏î: ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤";
        badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-teal-100 text-teal-700";
      }

      const container = document.getElementById('competencyListContainer');
      container.innerHTML = '';

      const dbKey = `${window.context.targetTeacherId}_${window.context.subjectId}`;
      const records = window.mockDB[dbKey] || {};

      sub.competencies.forEach((txt, i) => {
        const cKey = `c${i}`;
        const rec = records[cKey] || { self: null, head: null };
        const myValue = (window.currentMode === 'self') ? rec.self : rec.head;

        const passActive = (myValue === true) ? 'active' : '';
        const failActive = (myValue === false) ? 'active' : '';

        container.innerHTML += `
          <div class="bg-white border-b pb-4">
            <p class="mb-3 font-medium text-lg"><span class="text-slate-400 mr-2">${i + 1}.</span>${txt}</p>
            <div class="flex gap-2">
              <button onclick="check(this, '${cKey}', true)" class="btn-toggle btn-pass flex-1 py-3 rounded border font-bold text-slate-400 ${passActive}">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</button>
              <button onclick="check(this, '${cKey}', false)" class="btn-toggle btn-fail flex-1 py-3 rounded border font-bold text-slate-400 ${failActive}">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</button>
            </div>
          </div>`;
      });

      showPage('assessmentPage');
      updateScore();
    }

    function check(btn, cKey, val) {
      btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const dbKey = `${window.context.targetTeacherId}_${window.context.subjectId}`;
      if (!window.mockDB[dbKey]) window.mockDB[dbKey] = {};
      if (!window.mockDB[dbKey][cKey]) window.mockDB[dbKey][cKey] = { self: null, head: null };

      if (window.currentMode === 'self') window.mockDB[dbKey][cKey].self = val;
      else window.mockDB[dbKey][cKey].head = val;

      updateScore();
    }

    function updateScore() {
      const dbKey = `${window.context.targetTeacherId}_${window.context.subjectId}`;
      const sub = subjectsDB[window.context.subjectId];
      if (!sub) return;

      let count = 0;
      sub.competencies.forEach((_, i) => {
        const rec = (window.mockDB[dbKey] && window.mockDB[dbKey][`c${i}`]) ? window.mockDB[dbKey][`c${i}`] : null;
        if (rec) {
          const val = (window.currentMode === 'self') ? rec.self : rec.head;
          if (val === true) count++;
        }
      });
      document.getElementById('scoreSummary').innerText = `${count}/${sub.competencies.length}`;
    }

    function saveData() { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); }
    function exitAssessment() { if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?')) goBack('selectionPage'); }

    function clearAssessmentData() {
      const tid = window.context?.targetTeacherId;
      const subId = window.context?.subjectId;
      if (!tid || !subId) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô');

      const ok = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
      if (!ok) return;

      const dbKey = `${tid}_${subId}`;
      if (window.mockDB && window.mockDB[dbKey]) {
        Object.keys(window.mockDB[dbKey]).forEach(cKey => {
          window.mockDB[dbKey][cKey].self = null;
          window.mockDB[dbKey][cKey].head = null;
        });
      }
      renderForm();
      alert('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }

    // EXPORT
    function openExportModal() {
      const select = document.getElementById('exportTeacherSelect');
      select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π --</option>';

      upsertLoggedInUserToTeachersDB();

      const myId = window.currentUser?.teacherId || window.currentUser?.uid;
      const myName = window.currentUserProfile?.fullName || window.currentUser?.displayName || 'User';
      const role = window.currentUserProfile?.role;

      // ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
      // ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤: ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
      if (role === 'teacher') {
        if (myId) select.innerHTML += `<option value="${myId}">${myName} (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</option>`;
      } else {
        if (myId) select.innerHTML += `<option value="${myId}">${myName} (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</option>`;
        teachersDB.forEach(t => {
          if (t.id === myId) return;
          select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
      }

      document.getElementById('exportSelectModal').classList.remove('hidden');
    }

    function closeExportModal() { document.getElementById('exportSelectModal').classList.add('hidden'); }

    function confirmExportTeacher() {
      const tid = document.getElementById('exportTeacherSelect').value;
      if (!tid) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");

      const tData = teachersDB.find(t => t.id === tid);
      let allSubjects = [];
      Object.values(tData.schedule || {}).forEach(yearObj => {
        Object.values(yearObj || {}).forEach(termArr => { allSubjects.push(...termArr); });
      });
      allSubjects = [...new Set(allSubjects)];

      window.context = {
        targetTeacherId: tData.id,
        evaluateeName: tData.name,
        evaluatorName: '-',
        classLevel: '‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô',
        allSubjects: allSubjects,
        year: 'ALL',
        term: 'ALL'
      };

      closeExportModal();
      openPreview();
    }

    function openPreview() {
      document.getElementById('prevEvaluatee').innerText = window.context.evaluateeName;

      const role = window.currentUserProfile?.role;
      document.getElementById('prevPosition').innerText =
        role === 'teacher' ? '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô' :
        role === 'head' ? '‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤)' : '...';

      document.getElementById('printDate').innerText = new Date().toLocaleDateString('th-TH');

      const body = document.getElementById('previewBody');
      body.innerHTML = '';

      window.context.allSubjects.forEach(subID => {
        const sub = subjectsDB[subID];
        if (sub) {
          const dbKey = `${window.context.targetTeacherId}_${subID}`;
          const records = window.mockDB[dbKey] || {};
          let rows = '';

          sub.competencies.forEach((comp, i) => {
            const rec = records[`c${i}`] || { self: null, head: null };
            const badge = (val) => {
              if (val === true) return '<span class="badge-pass">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</span>';
              if (val === false) return '<span class="badge-fail">‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>';
              return '<span class="badge-wait">‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>';
            };

            rows += `
              <tr class="border-b border-slate-100">
                <td class="p-2 text-sm text-slate-700">${i + 1}. ${comp}</td>
                <td class="p-2 text-center bg-slate-50">${badge(rec.self)}</td>
                <td class="p-2 text-center bg-white">${badge(rec.head)}</td>
              </tr>`;
          });

          body.innerHTML += `
            <div class="mb-6 avoid-break border border-slate-200 rounded-lg overflow-hidden">
              <div class="bg-indigo-50 px-4 py-2 border-b border-indigo-100">
                <h3 class="font-bold text-indigo-800 text-sm">üìò ‡∏ß‡∏¥‡∏ä‡∏≤: ${sub.name}</h3>
              </div>
              <table class="w-full text-left border-collapse">
                <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                  <tr>
                    <th class="p-2 pl-4 w-1/2">‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</th>
                    <th class="p-2 text-center w-1/4">‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (Self)</th>
                    <th class="p-2 text-center w-1/4">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ (Head)</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>`;
        }
      });

      document.getElementById('previewModal').classList.remove('hidden');
    }

    function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }

    function downloadPDF() {
      const element = document.getElementById('pdfContent');
      const opt = {
        margin: 0,
        filename: `Report_Portfolio.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
<script>
  // ‚úÖ DEMO MODE (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö file:/// ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å Login)
  document.addEventListener('DOMContentLoaded', () => {
    const demoBtn = document.getElementById('demoBtn');
    if (!demoBtn) return;

    demoBtn.addEventListener('click', () => {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡∏à‡∏≥‡∏•‡∏≠‡∏á
      window.currentUser = {
        uid: 'demo_user_001',
        email: 'demo@local',
        displayName: 'Demo User',
        teacherId: 'demo_user_001'
      };

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á profile ‡∏à‡∏≥‡∏•‡∏≠‡∏á
      window.currentUserProfile = {
        fullName: 'Demo User',
        role: 'teacher'   // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'head' ‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤
      };

      // ‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤ teachersDB
      if (typeof upsertLoggedInUserToTeachersDB === 'function') {
        upsertLoggedInUserToTeachersDB();
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ selection
      const ud = document.getElementById('userDisplay');
      if (ud) ud.innerText = window.currentUserProfile.fullName;

      // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ selection
      if (typeof showPage === 'function') showPage('selectionPage');
    });
  });
</script>
</body>
</html>
